name: Build OpenWrt Packages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  
jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install zstd build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev python3-venv rsync unzip zlib1g-dev file wget
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v3
        with:
          path: sdk
          key: openwrt-sdk-snapshot-x86-64
          
      - name: Initialize SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        env:
          url_sdk: https://archive.openwrt.org/releases/24.10.3/targets/x86/64/openwrt-sdk-24.10.3-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst
        run: |
          wget ${{ env.url_sdk }}
          file_name=$(basename "${{ env.url_sdk }}")
          mkdir -p sdk && tar --zstd -xvf "$file_name" -C ./sdk --strip-components=1
          cd sdk
          echo "src-git base https://github.com/openwrt/openwrt.git;main" > feeds.conf
          echo "src-git-full packages https://github.com/openwrt/packages.git;master" >> feeds.conf
          echo "src-git-full luci https://github.com/openwrt/luci.git;master" >> feeds.conf
          echo "src-git-full routing https://git.openwrt.org/feed/routing.git;master"  >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make download -j$(nproc)

      - name: Sync third-party plugins into sdk/package
        run: |
          # 覆盖官方 luci-app-advanced-reboot
          rm -rf sdk/feeds/luci/applications/luci-app-advanced-reboot sdk/package/feeds/luci/applications/luci-app-advanced-reboot
          rm -rf sdk/package/luci-app-advanced-reboot
          git clone --depth=1 https://github.com/stangri/luci-app-advanced-reboot.git sdk/package/luci-app-advanced-reboot

          # 其它第三方插件（统一放 sdk/package 下，避免通配符与 symlink）
          git clone -b master https://github.com/jerrykuku/luci-theme-argon.git sdk/package/luci-theme-argon
          git clone --depth=1 https://github.com/muink/luci-app-natmapt.git sdk/package/luci-app-natmapt
          git clone --depth=1 https://github.com/xiaorouji/openwrt-passwall2.git sdk/package/luci-app-passwall2
          git clone --depth=1 https://github.com/gSpotx2f/luci-app-cpu-status.git sdk/package/luci-app-cpu-status
          git clone --depth=1 https://github.com/gSpotx2f/luci-app-log.git sdk/package/luci-app-log

      - name: Configure build (non-interactive)
        run: |
          cd sdk
          chmod +x ./scripts/config

          # 基础开关
          ./scripts/config --disable CONFIG_ALL_NONSHARED
          ./scripts/config --disable CONFIG_ALL_KMODS
          ./scripts/config --disable CONFIG_ALL
          ./scripts/config --disable CONFIG_AUTOREMOVE

          # 语言支持
          ./scripts/config --enable CONFIG_LUCI_LANG_zh_Hans

          # 插件选择
          ./scripts/config --module CONFIG_PACKAGE_luci-theme-argon
          ./scripts/config --module CONFIG_PACKAGE_luci-app-advanced-reboot
          ./scripts/config --module CONFIG_PACKAGE_luci-app-passwall2
          ./scripts/config --module CONFIG_PACKAGE_luci-app-natmapt
          ./scripts/config --module CONFIG_PACKAGE_luci-app-cpu-status
          ./scripts/config --module CONFIG_PACKAGE_luci-app-log

          # libcurl 强制使用 mbedTLS
          ./scripts/config --enable CONFIG_PACKAGE_libcurl
          ./scripts/config --disable CONFIG_LIBCURL_OPENSSL
          ./scripts/config --disable CONFIG_LIBCURL_WOLFSSL
          ./scripts/config --enable CONFIG_LIBCURL_MBEDTLS

          make defconfig

      - name: Compile packages from targets.txt
        run: |
          set -e
          make -C sdk defconfig
          while read pkg; do
            [ -z "$pkg" ] && continue
            echo "=== Building $pkg ==="
            if [ -d "sdk/package/$pkg" ]; then
              make -C sdk package/$pkg/{clean,compile} -j"$(nproc)" V=s
            else
              echo "ERROR: sdk/package/$pkg not found. Ensure clone step uses this exact directory name."
              exit 1
            fi
          done < targets.txt

      - name: Generate Packages index
        run: |
          # x86_64/base 路径为 SDK 的默认输出之一，生成索引
          outdir=$(echo sdk/bin/packages/*/base)
          cd "$outdir"
          ../../../../staging_dir/host/bin/opkg-make-index . > Packages
          gzip -9c Packages > Packages.gz
          ls -la

      - name: Upload release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest packages
          files: |
            sdk/bin/packages/*/base/*.ipk
            sdk/bin/packages/*/base/Packages*
